<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ŽIVOTINjARI</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e0ffe0, #c0f0ff);
      margin: 0; padding: 0;
    }
    header {
      background: #2e8b57;
      color: white;
      padding: 15px;
      text-align: center;
    }
    .container { max-width: 800px; margin: auto; padding: 10px; }
    .hidden { display: none; }
    .card {
      background: white; border-radius: 12px; padding: 15px;
      margin: 10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    input, textarea, select {
      width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #aaa;
    }
    button {
      background: #2e8b57; color: white; border: none; padding: 10px 15px;
      border-radius: 8px; cursor: pointer; margin-top: 5px;
    }
    button.danger { background: #8b0000; }
    #messages { height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 10px; }
    .msg { background: #d9fdd3; margin: 5px 0; padding: 8px; border-radius: 8px; }
  </style>
</head>
<body>
  <header><h2>ŽIVOTINjARI</h2></header>
  <div class="container">

    <!-- LOGIN -->
    <div id="login" class="card">
      <h3>Prijava</h3>
      <input type="text" id="username" placeholder="Korisničko ime">
      <input type="password" id="password" placeholder="Lozinka">
      <button onclick="login()">Prijavi se</button>
      <p id="login-error" style="color:red;"></p>
    </div>

    <!-- CHAT -->
    <div id="chat" class="card hidden">
      <h3>Chat</h3>
      <div id="messages"></div>
      <div style="display:flex;gap:5px;">
        <input type="text" id="messageInput" placeholder="Unesi poruku...">
        <button onclick="sendMessage()">Pošalji</button>
      </div>
    </div>

    <!-- OBAJEŠTENJA -->
    <div id="announcements" class="card hidden">
      <h3>Obaveštenja</h3>
      <ul id="announcementList"></ul>
    </div>

    <!-- SASTANCI -->
    <div id="meetings" class="card hidden">
      <h3>Sastanci</h3>
      <ul id="meetingList"></ul>
    </div>

    <!-- OCENE -->
    <div id="grades" class="card hidden">
      <h3>Moje ocene</h3>
      <ul id="gradeList"></ul>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="card hidden">
      <h3>Admin Panel</h3>

      <h4>Dodaj korisnika</h4>
      <input id="newUser" placeholder="Korisničko ime">
      <input id="newPass" placeholder="Lozinka">
      <button onclick="addUser()">Dodaj korisnika</button>

      <h4>Objavi obaveštenje</h4>
      <textarea id="announcement"></textarea>
      <button onclick="postAnnouncement()">Objavi</button>

      <h4>Dodaj sastanak</h4>
      <textarea id="meeting"></textarea>
      <button onclick="postMeeting()">Dodaj</button>

      <h4>Upiši ocenu</h4>
      <input id="gradeUser" placeholder="Korisničko ime">
      <input id="subject" placeholder="Predmet">
      <input id="grade" placeholder="Ocena">
      <button onclick="addGrade()">Dodaj ocenu</button>
    </div>

  </div>

  <script>
    let currentUser = null;

    // --- LOGIN ---
    async function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("http://localhost:3000/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          document.getElementById("login-error").textContent = "Pogrešno ime ili lozinka!";
          return;
        }

        currentUser = await res.json();

        document.getElementById("login").classList.add("hidden");
        document.getElementById("chat").classList.remove("hidden");
        document.getElementById("announcements").classList.remove("hidden");
        document.getElementById("meetings").classList.remove("hidden");
        document.getElementById("grades").classList.remove("hidden");

        if(currentUser.admin) {
          document.getElementById("admin-panel").classList.remove("hidden");
        }

        loadAll();
      } catch(err) {
        console.error(err);
        alert("Server nije dostupan.");
      }
    }

    // --- LOADING ---
    async function loadAll() {
      await loadMessages();
      await loadAnnouncements();
      await loadMeetings();
      await loadGrades();
    }

    async function loadMessages() {
      const msgs = JSON.parse(localStorage.getItem("messages")||"[]"); // chat još lokalno
      const container = document.getElementById("messages");
      container.innerHTML = "";
      msgs.forEach(m=>{
        const div=document.createElement("div");
        div.className="msg"; div.textContent=`${m.username}: ${m.text}`;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      if(!text) return;

      const msgs = JSON.parse(localStorage.getItem("messages")||"[]");
      msgs.push({username:currentUser.username, text});
      localStorage.setItem("messages", JSON.stringify(msgs));

      document.getElementById("messageInput").value="";
      await loadMessages();
    }

    async function loadAnnouncements() {
      const res = await fetch("http://localhost:3000/announcements");
      const list = await res.json();
      const ul = document.getElementById("announcementList");
      ul.innerHTML="";
      list.forEach(a=>{
        const li=document.createElement("li");
        li.textContent=`${a.text} (${a.time})`;
        ul.appendChild(li);
      });
    }

    async function loadMeetings() {
      const res = await fetch("http://localhost:3000/meetings");
      const list = await res.json();
      const ul = document.getElementById("meetingList");
      ul.innerHTML="";
      list.forEach(m=>{
        const li=document.createElement("li");
        li.textContent=`${m.text} (${m.time})`;
        ul.appendChild(li);
      });
    }

    async function loadGrades() {
      const res = await fetch("http://localhost:3000/grades");
      const list = await res.json();
      const ul = document.getElementById("gradeList");
      ul.innerHTML="";
      list.filter(g=>g.username===currentUser.username).forEach(g=>{
        const li = document.createElement("li");
        li.textContent = `${g.subject}: ${g.grade}`;
        ul.appendChild(li);
      });
    }

    // --- ADMIN FUNCTIONS ---
    async function addUser() {
      const u = document.getElementById("newUser").value.trim();
      const p = document.getElementById("newPass").value.trim();
      if(!u||!p) return alert("Unesi podatke");

      const res = await fetch("http://localhost:3000/addUser", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username:u, password:p, admin:false })
      });
      const data = await res.json();
      if(data.success) alert("Korisnik dodat!");
      document.getElementById("newUser").value="";
      document.getElementById("newPass").value="";
    }

    async function postAnnouncement() {
      const t = document.getElementById("announcement").value.trim();
      if(!t) return;
      await fetch("http://localhost:3000/announcement", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({text:t})
      });
      document.getElementById("announcement").value="";
      await loadAnnouncements();
    }

    async function postMeeting() {
      const t = document.getElementById("meeting").value.trim();
      if(!t) return;
      await fetch("http://localhost:3000/meeting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({text:t})
      });
      document.getElementById("meeting").value="";
      await loadMeetings();
    }

    async function addGrade() {
      const u=document.getElementById("gradeUser").value.trim();
      const sub=document.getElementById("subject").value.trim();
      const g=document.getElementById("grade").value.trim();
      if(!u||!sub||!g) return alert("Popuni sve");
      await fetch("http://localhost:3000/grade", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username:u, subject:sub, grade:g})
      });
      document.getElementById("gradeUser").value="";
      document.getElementById("subject").value="";
      document.getElementById("grade").value="";
      await loadGrades();
    }

  </script>
</body>
</html>
