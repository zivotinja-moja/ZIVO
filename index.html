<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ŽIVOTINjARI</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e0ffe0, #c0f0ff);
      margin: 0;
      padding: 0;
    }
    header {
      background: #2e8b57;
      color: white;
      padding: 15px;
      text-align: center;
    }
    .container { max-width: 800px; margin: auto; padding: 10px; }
    .hidden { display: none; }
    .card {
      background: white; border-radius: 12px; padding: 15px;
      margin: 10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    input, textarea, select {
      width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #aaa;
    }
    button {
      background: #2e8b57; color: white; border: none; padding: 10px 15px;
      border-radius: 8px; cursor: pointer; margin-top: 5px;
    }
    button.danger { background: #8b0000; }
    #messages { height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 10px; }
    .msg { background: #d9fdd3; margin: 5px 0; padding: 8px; border-radius: 8px; }
  </style>
</head>
<body>
  <header><h2>ŽIVOTINjARI</h2></header>
  <div class="container">

    <!-- LOGIN -->
    <div id="login" class="card">
      <h3>Prijava</h3>
      <input type="text" id="username" placeholder="Korisničko ime">
      <input type="password" id="password" placeholder="Lozinka">
      <button onclick="login()">Prijavi se</button>
      <p id="login-error" style="color:red;"></p>
    </div>

    <!-- CHAT -->
    <div id="chat" class="card hidden">
      <h3>Chat</h3>
      <div id="messages"></div>
      <div style="display:flex;gap:5px;">
        <input type="text" id="messageInput" placeholder="Unesi poruku...">
        <button onclick="sendMessage()">Pošalji</button>
      </div>
    </div>

    <!-- OBAJEŠTENJA -->
    <div id="announcements" class="card hidden">
      <h3>Obaveštenja</h3>
      <ul id="announcementList"></ul>
    </div>

    <!-- SASTANCI -->
    <div id="meetings" class="card hidden">
      <h3>Sastanci</h3>
      <ul id="meetingList"></ul>
    </div>

    <!-- OCENE -->
    <div id="grades" class="card hidden">
      <h3>Moje ocene</h3>
      <ul id="gradeList"></ul>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="card hidden">
      <h3>Admin Panel</h3>

      <h4>Dodaj korisnika</h4>
      <input id="newUser" placeholder="Korisničko ime">
      <input id="newPass" placeholder="Lozinka">
      <button onclick="addUser()">Dodaj korisnika</button>

      <h4>Objavi obaveštenje</h4>
      <textarea id="announcement"></textarea>
      <button onclick="postAnnouncement()">Objavi</button>

      <h4>Dodaj sastanak</h4>
      <textarea id="meeting"></textarea>
      <button onclick="postMeeting()">Dodaj</button>

      <h4>Upiši ocenu</h4>
      <input id="gradeUser" placeholder="Korisničko ime">
      <input id="subject" placeholder="Predmet">
      <input id="grade" placeholder="Ocena">
      <button onclick="addGrade()">Dodaj ocenu</button>
    </div>
  </div>

  <script>
    let currentUser = null;
    const API = "/api";

    async function login() {
      const u = username.value, p = password.value;
      const res = await fetch(API + "/users"); const users = await res.json();
      const user = users.find(x => x.username === u && x.password === p);
      if (!user) { login-error.textContent = "Pogrešno!"; return; }

      currentUser = user;
      login.classList.add("hidden");
      chat.classList.remove("hidden");
      announcements.classList.remove("hidden");
      meetings.classList.remove("hidden");
      grades.classList.remove("hidden");
      if (user.username === "djole.b") admin-panel.classList.remove("hidden");
      loadAll();
    }

    async function loadAll() {
      loadMessages(); loadAnnouncements(); loadMeetings(); loadGrades();
    }

    async function loadMessages() {
      const res = await fetch(API + "/messages"); const msgs = await res.json();
      messages.innerHTML = "";
      msgs.forEach(m => {
        const div = document.createElement("div");
        div.className="msg"; div.textContent=`${m.username}: ${m.text}`;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage() {
      const text = messageInput.value.trim(); if (!text) return;
      await fetch(API+"/messages",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username:currentUser.username,text})});
      messageInput.value=""; loadMessages();
    }

    async function loadAnnouncements() {
      const res=await fetch(API+"/announcements"); const list=await res.json();
      announcementList.innerHTML=""; list.forEach(a=>{
        const li=document.createElement("li"); li.textContent=a.text+" ("+a.time+")";
        announcementList.appendChild(li);
      });
    }

    async function loadMeetings() {
      const res=await fetch(API+"/meetings"); const list=await res.json();
      meetingList.innerHTML=""; list.forEach(m=>{
        const li=document.createElement("li"); li.textContent=m.text+" ("+m.time+")";
        meetingList.appendChild(li);
      });
    }

    async function loadGrades() {
      const res=await fetch(API+"/grades"); const list=await res.json();
      gradeList.innerHTML="";
      list.filter(g=>g.username===currentUser.username).forEach(g=>{
        const li=document.createElement("li"); li.textContent=`${g.subject}: ${g.grade}`;
        gradeList.appendChild(li);
      });
    }

    // ADMIN
    async function addUser() {
      const u=newUser.value.trim(), p=newPass.value.trim(); if(!u||!p)return;
      await fetch(API+"/users",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username:u,password:p})});
      alert("Korisnik dodat!"); newUser.value=""; newPass.value="";
    }

    async function postAnnouncement() {
      const t=announcement.value.trim(); if(!t)return;
      await fetch(API+"/announcements",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text:t,time:new Date().toLocaleString()})});
      announcement.value=""; loadAnnouncements();
    }

    async function postMeeting() {
      const t=meeting.value.trim(); if(!t)return;
      await fetch(API+"/meetings",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text:t,time:new Date().toLocaleString()})});
      meeting.value=""; loadMeetings();
    }

    async function addGrade() {
      const u=gradeUser.value.trim(), s=subject.value.trim(), g=grade.value.trim();
      if(!u||!s||!g)return;
      await fetch(API+"/grades",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username:u,subject:s,grade:g})});
      gradeUser.value=""; subject.value=""; grade.value=""; loadGrades();
    }
  </script>
</body>
  </html>
